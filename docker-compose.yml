version: "3.9"

services:
  web:
    container_name: stq_web
    build: .
    command: python manage.py runserver 0.0.0.0:${WEB_PORT}
    volumes:
      - .:/app
    ports:
      - "${WEB_PORT}:${WEB_PORT}"
    depends_on:
      mariadb:
        condition: service_healthy
    environment:
      DATABASE_HOST: mariadb
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
    networks:
      - stq_network

  frontend:
    container_name: stq_frontend
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./apps/web:/app
    command: sh -c "npm install && npm run dev"
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: http://web:${WEB_PORT}
    depends_on:
      - web
    networks:
      - stq_network

  nginx:
    container_name: stq_nginx
    image: nginx:alpine
    ports:
      - "${NGINX_HOST_PORT}:${NGINX_CONTAINER_PORT}"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/app/static:ro
    depends_on:
      - web
    networks:
      - stq_network

  worker:
    container_name: stq_worker
    build: .
    command: python manage.py qcluster
    volumes:
      - .:/app
    depends_on:
      - web
    environment:
      DATABASE_HOST: mariadb
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_USER: ${DATABASE_USER}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
    networks:
      - stq_network

  mariadb:
    container_name: stq_mariadb
    image: mariadb:10.11
    command: --log-bin=mysql-bin
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb_data:/var/lib/mysql
    ports:
      - "3308:3306"
    networks:
      - stq_network
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s

  n8n:
    container_name: n8n
    image: docker.n8n.io/n8nio/n8n
    ports:
      - "62000:5678"
    environment:
      N8N_HOST: n8n.ishenwei.online
      N8N_PORT: 5678
      N8N_PROTOCOL: https
      NODE_ENV: production
      GENERIC_TIMEZONE: America/New_York
      FILE_STORAGE_PATH: /files
    volumes:
      - ./n8n_data:/home/node/.n8n
      - ./n8n_data/files:/home/node/.n8n-files
    restart: unless-stopped
    networks:
      - stq_network

networks:
  stq_network:
    driver: bridge

volumes:
  mariadb_data:
  n8n_data:
